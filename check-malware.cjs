#!/usr/bin/env node

const https = require('https');
const fs = require('fs');

// Read the compromised package list from local file
function fetchCompromisedPackages() {
  return Promise.resolve(fs.readFileSync('shai-hulud-2.0.csv', 'utf8'));
}

// Parse CSV data
function parseCSV(csvData) {
  const lines = csvData.trim().split('\n');
  const compromised = new Map();

  // Skip header row
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;

    const [packageName, version] = line.split(',');
    if (packageName && version) {
      if (!compromised.has(packageName)) {
        compromised.set(packageName, []);
      }
      compromised.get(packageName).push(version);
    }
  }

  return compromised;
}

// Extract all packages from package-lock.json
function extractInstalledPackages(lockfile) {
  const installed = new Map();

  if (lockfile.packages) {
    for (const [path, pkg] of Object.entries(lockfile.packages)) {
      if (!pkg.version) continue;

      // Extract package name from path
      let name;
      if (path === '') {
        // Root package
        name = lockfile.name;
      } else {
        // Remove 'node_modules/' prefix
        const cleanPath = path.replace(/^node_modules\//, '');
        // Handle scoped packages
        if (cleanPath.startsWith('@')) {
          const parts = cleanPath.split('/');
          name = `${parts[0]}/${parts[1]}`;
        } else {
          name = cleanPath.split('/')[0];
        }
      }

      if (name) {
        installed.set(name, pkg.version);
      }
    }
  }

  return installed;
}

// Main function
async function checkForMalware() {
  try {
    console.log('üîç Fetching Shai-Hulud 2.0 compromised package list...\n');
    const csvData = await fetchCompromisedPackages();
    const compromised = parseCSV(csvData);

    console.log(`üìä Found ${compromised.size} unique compromised packages in the list\n`);

    console.log('üì¶ Reading package-lock.json...\n');
    const lockfile = JSON.parse(fs.readFileSync('package-lock.json', 'utf8'));
    const installed = extractInstalledPackages(lockfile);

    console.log(`üìä Found ${installed.size} installed packages (including transitive dependencies)\n`);

    console.log('üîé Checking for matches...\n');
    console.log('='.repeat(80));

    const matches = [];

    for (const [pkgName, installedVersion] of installed.entries()) {
      if (compromised.has(pkgName)) {
        const compromisedVersions = compromised.get(pkgName);
        if (compromisedVersions.includes(installedVersion)) {
          matches.push({
            name: pkgName,
            version: installedVersion,
            exactMatch: true
          });
        } else {
          matches.push({
            name: pkgName,
            version: installedVersion,
            exactMatch: false,
            compromisedVersions: compromisedVersions
          });
        }
      }
    }

    if (matches.length === 0) {
      console.log('\n‚úÖ GOOD NEWS: No compromised packages detected!\n');
      console.log('Your project appears to be safe from Shai-Hulud 2.0 malware.');
    } else {
      console.log('\n‚ö†Ô∏è  WARNING: Potential matches found!\n');

      const exactMatches = matches.filter(m => m.exactMatch);
      const nameMatches = matches.filter(m => !m.exactMatch);

      if (exactMatches.length > 0) {
        console.log('üö® EXACT MATCHES (package name AND version match):');
        console.log('='.repeat(80));
        exactMatches.forEach(m => {
          console.log(`  ‚ùå ${m.name}@${m.version}`);
        });
        console.log();
      }

      if (nameMatches.length > 0) {
        console.log('‚ö†Ô∏è  PACKAGE NAME MATCHES (different version):');
        console.log('='.repeat(80));
        nameMatches.forEach(m => {
          console.log(`  ‚ö†Ô∏è  ${m.name}`);
          console.log(`     Installed: ${m.version}`);
          console.log(`     Compromised versions: ${m.compromisedVersions.join(', ')}`);
          console.log();
        });
      }

      if (exactMatches.length > 0) {
        console.log('\nüî¥ ACTION REQUIRED:');
        console.log('You have EXACT matches for compromised packages.');
        console.log('These packages should be removed immediately!');
        console.log('\nRecommended actions:');
        console.log('1. Remove the compromised packages');
        console.log('2. Update to safe versions');
        console.log('3. Review your code for any malicious activity');
        console.log('4. Check for unauthorized data access or modifications');
      }
    }

    console.log('\n' + '='.repeat(80));
    console.log(`\nüìã Summary:`);
    console.log(`   Total installed packages: ${installed.size}`);
    console.log(`   Compromised package list size: ${compromised.size}`);
    console.log(`   Exact matches: ${matches.filter(m => m.exactMatch).length}`);
    console.log(`   Name matches (different version): ${matches.filter(m => !m.exactMatch).length}`);

  } catch (error) {
    console.error('‚ùå Error:', error.message);
    process.exit(1);
  }
}

checkForMalware();
